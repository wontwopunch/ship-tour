<%- include('layouts/navbar') %>
<div class="container">
  <h1>월별 좌석 현황</h1>

  <!-- 필터링 옵션 -->
  <div class="filters">
    <label for="monthSelect">월 선택:</label>
    <select id="monthSelect" onchange="applyFilters()">
      <% for (let i = 1; i <= 12; i++) { %>
        <option value="<%= i %>" <%= currentMonth == i ? 'selected' : '' %>><%= i %>월</option>
      <% } %>
    </select>
  </div>
  <button onclick="saveBlockData()">블럭 데이터 저장</button>
  <!-- 테이블 -->
  <div class="table-container">
    <table border="1">
      <thead>
        <tr>
          <th>날짜</th>
          <th colspan="9">포항출항</th>
          <th colspan="9">울릉출항</th>
        </tr>
        <tr>
          <th>월/일/요일</th>
          <th>예약 이코</th>
          <th>예약 비즈</th>
          <th>예약 퍼스</th>
          <th>블럭 이코</th>
          <th>블럭 비즈</th>
          <th>블럭 퍼스</th>
          <th>잔여 이코</th>
          <th>잔여 비즈</th>
          <th>잔여 퍼스</th>
          <th>예약 이코</th>
          <th>예약 비즈</th>
          <th>예약 퍼스</th>
          <th>블럭 이코</th>
          <th>블럭 비즈</th>
          <th>블럭 퍼스</th>
          <th>잔여 이코</th>
          <th>잔여 비즈</th>
          <th>잔여 퍼스</th>
        </tr>
      </thead>
      <tbody>
        <% data.forEach(row => { %>
          <tr>
            <!-- 날짜 -->
            <td>
              <%= row.date %> 
              (<%= ['일', '월', '화', '수', '목', '금', '토'][new Date(row.date).getDay()] %>)
            </td>
        
            <!-- 포항출항 -->
            <td style="background-color: #d7fbe8;"><%= row.departure.economy || 0 %></td>
            <td style="background-color: #d7fbe8;"><%= row.departure.business || 0 %></td>
            <td style="background-color: #d7fbe8;"><%= row.departure.first || 0 %></td>
            <td style="background-color: #fcd5d5;"><input type="number" value="<%= row.departure.ecoBlock || 0 %>" data-field="departure.ecoBlock"></td>
            <td style="background-color: #fcd5d5;"><input type="number" value="<%= row.departure.bizBlock || 0 %>" data-field="departure.bizBlock"></td>
            <td style="background-color: #fcd5d5;"><input type="number" value="<%= row.departure.firstBlock || 0 %>" data-field="departure.firstBlock"></td>
            <td style="background-color: #e6d9fb; color: <%= ((row.departure.ecoBlock || 0) - (row.departure.economy || 0)) < 0 ? 'red' : 'inherit' %>;">
              <%= (row.departure.ecoBlock || 0) - (row.departure.economy || 0) %>
            </td>
            <td style="background-color: #e6d9fb; color: <%= ((row.departure.bizBlock || 0) - (row.departure.business || 0)) < 0 ? 'red' : 'inherit' %>;">
              <%= (row.departure.bizBlock || 0) - (row.departure.business || 0) %>
            </td>
            <td style="background-color: #e6d9fb; color: <%= ((row.departure.firstBlock || 0) - (row.departure.first || 0)) < 0 ? 'red' : 'inherit' %>;">
              <%= (row.departure.firstBlock || 0) - (row.departure.first || 0) %>
            </td>

            <!-- 울릉출항 -->
            <td style="background-color: #d7fbe8;"><%= row.arrival.economy || 0 %></td>
            <td style="background-color: #d7fbe8;"><%= row.arrival.business || 0 %></td>
            <td style="background-color: #d7fbe8;"><%= row.arrival.first || 0 %></td>
            <td style="background-color: #fcd5d5;"><input type="number" value="<%= row.arrival.ecoBlock || 0 %>" data-field="arrival.ecoBlock"></td>
            <td style="background-color: #fcd5d5;"><input type="number" value="<%= row.arrival.bizBlock || 0 %>" data-field="arrival.bizBlock"></td>
            <td style="background-color: #fcd5d5;"><input type="number" value="<%= row.arrival.firstBlock || 0 %>" data-field="arrival.firstBlock"></td>
            <td style="background-color: #e6d9fb; color: <%= ((row.arrival.ecoBlock || 0) - (row.arrival.economy || 0)) < 0 ? 'red' : 'inherit' %>;">
              <%= (row.arrival.ecoBlock || 0) - (row.arrival.economy || 0) %>
            </td>
            <td style="background-color: #e6d9fb; color: <%= ((row.arrival.bizBlock || 0) - (row.arrival.business || 0)) < 0 ? 'red' : 'inherit' %>;">
              <%= (row.arrival.bizBlock || 0) - (row.arrival.business || 0) %>
            </td>
            <td style="background-color: #e6d9fb; color: <%= ((row.arrival.firstBlock || 0) - (row.arrival.first || 0)) < 0 ? 'red' : 'inherit' %>;">
              <%= (row.arrival.firstBlock || 0) - (row.arrival.first || 0) %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <button onclick="downloadExcel()">엑셀 다운로드</button>
</div>

<script>
  // 필터 적용 함수
  function applyFilters() {
  const month = document.getElementById('monthSelect').value;
  window.location.href = `/status/monthly?month=${month}`;
}

  function downloadExcel() {
    const month = document.getElementById('monthSelect').value;
    window.location.href = `/status/monthly/export?month=${month}`;
  }


  // 실시간 업데이트
  document.querySelectorAll('[contenteditable="true"]').forEach((cell) => {
    cell.addEventListener('blur', (e) => {
      const value = parseInt(e.target.innerText.trim(), 10) || 0;
      const field = e.target.getAttribute('data-field');
      const [type, key] = field.split('-');
      const date = e.target.closest('tr').querySelector('td:first-child').innerText.trim();

      fetch(`/status/update-block`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, type, key, value }),
      })
        .then((response) => response.json())
        .then((result) => {
          if (!result.success) {
            alert('업데이트 실패');
          }
        });
    });
  });

function saveBlockData() {
  const rows = document.querySelectorAll('tbody tr');
  const updates = [];

  rows.forEach((row) => {
    const id = row.getAttribute('data-id');
    if (id) {
      updates.push({
        _id: id,
        'departure.ecoBlock': row.querySelector('[data-field="departure.ecoBlock"]').value || 0,
        'departure.bizBlock': row.querySelector('[data-field="departure.bizBlock"]').value || 0,
        'departure.firstBlock': row.querySelector('[data-field="departure.firstBlock"]').value || 0,
        'arrival.ecoBlock': row.querySelector('[data-field="arrival.ecoBlock"]').value || 0,
        'arrival.bizBlock': row.querySelector('[data-field="arrival.bizBlock"]').value || 0,
        'arrival.firstBlock': row.querySelector('[data-field="arrival.firstBlock"]').value || 0,
      });
    }
  });

  fetch('/status/monthly/update-block', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ updates }),
  })
    .then((response) => response.json())
    .then((data) => {
      if (data.success) {
        alert('블럭 데이터가 저장되었습니다.');
        location.reload();
      } else {
        alert('블럭 데이터 저장 중 오류가 발생했습니다.');
      }
    })
    .catch((error) => {
      console.error('Error saving block data:', error);
      alert('블럭 데이터 저장 중 오류가 발생했습니다.');
    });
}

</script>

<style>
  .filters {
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .table-container {
    margin-top: 20px;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
  }

  table th {
    background-color: #007bff;
    color: white;
    padding: 10px;
  }

  table td {
    padding: 8px;
  }

  table tr:nth-child(even) {
    background-color: #f2f2f2;
  }

  table tr:hover {
    background-color: #eef;
  }

  button {
    margin-top: 20px;
    padding: 10px 15px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  button:hover {
    background-color: #218838;
  }
</style>
